# 📚 데드락 DeadLock & 기아상태 Starvation

<br>

<br>

## 1. 데드락

<br>

> 프로세스가 자원을 얻지 못해서 다음 처리를 하지 못하는 상태
>
> 시스템적으로 한정된 자원을 여러 곳에서 사용하려고 할 때 발생
>
> 즉, 둘 이상의 프로세스가 다른 프로세스가 점유중인 자원을 서로 기다릴 때 무한 대기에 빠지는 상황
>
> '교착 상태'라고도 부름

<br>

#### 데드락이 발생할 수 있는 경우

<img src="https://t1.daumcdn.net/cfile/tistory/243E89355714C26E28">

프로세스1과 2가 자원1,2를 모두 얻어야 한다고 가정

t1 : 프로세스1이 자원1을 얻음 / 프로세스2가 자원2를 얻음

t2 : 프로세스1은 자원2를 기다림 / 프로세스2는 자원1을 기다림

현재 서로 원하는 자원이 상대방에 할당되어 있어서 두 프로세스는 무한정 wait 상태에 빠지는 상황을 `DeadLock` 상태라 함

<br>

#### 주로 발생하는 경우

- 멀티 프로그래밍 환경에서 한정된 자원을 얻기 위해 서로 경쟁하는 상황 발생

- 한 프로세스가 자원을 요청했을 때, 동시에 그 자원을 사용할 수 없는 상황이 발생할 수 있음. 이때 프로세스는 대기 상태로 들어감

- 대기 상태로 들어간 프로세스들이 실행 상태로 변경될 수 없을 때 '교착 상태' 발생

<br>

## 2. 데드락 발생 조건

<br>

> 4가지 모두 성립해야 데드락 발생
>
> (하나라도 성립하지 않으면 데드락 문제 해결 가능)

1. 상호 배제(Mutual exclusion)

   > 자원은 한번에 한 프로세스만 사용할 수 있어야 함

2. 점유 대기(Hold and wait)

   > 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 존재해야 함

3. 비선점(No preemption)

   > 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없어야 함

4. 순환 대기(Circular wait)

   > 프로세스의 집합에서 순환 형태로 자원을 대기하고 있어야 함

<br>

## 3. 데드락 해결법

<br>

1. 데드락이 발생하지 않도록 `예방` (prevention)

2. 데드락 발생 가능을 인정하면서도 적절히 `회피` (avoidance)

3. 데드락 발생을 허용하지만 데드락을 `탐지` (detection) 하여, 데드락에서 `회복`

<br>

### 데드락 예방 (Prevention)

> 데드락의 발생 조건 4가지 중 하나라도 발생하지 않게 하는 것
>
> 즉, 각각의 조건을 방지(부정)하여 데드락 발생 가능성을 차단

- 상호배제 부정 : 한번에 여러 프로세스가 공유 자원을 사용할 수 있게 함

  - 추후 동기화 문제 발생 가능

- 점유대기 부정 : 프로세스 실행전 모든 자원을 할당. 다른 자원을 점유하기 위한 대기조건을 성립하지 않도록 함

- 비선점 부정 : 다른 프로세스에게 할당된 자원이 선점권이 없다 가정할 때, 높은 우선순위의 프로세스가 해당 자원을 선점할 수 있도록 함

- 순환대기 부정 : 자원에 고유번호 할당 후 순서대로 자원 요구. 자원을 순환 형태로 대기하지 않도록 일정한 한 쪽 방향으로만 자원을 요구할 수 있도록 함

이렇게 예방하는 방법은 **시스템의 처리량이나 효율성을 떨어트리는 단점**이 발생 가능

회피법은 조금 덜 제한적인 방법으로 예방법의 단점을 일부 해결

<br>

### 데드락 회피(Avoidance)

> 교착 상태 발생 시 피해나가는 방법

`Safe sequence`, `Safe state` 등이 키워드

시스템의 프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례로 모두에게 할당해 줄 수 있다면 안정 상태(safe state)에 있다고 함

그리고 이처럼 특정한 순서로 프로세스들에게 자원을 할당, 실행 및 종료 등의 작업을 할 때 데드락이 발생하지 않는 순서를 찾을 수 있다면, 그것을 안전 순서(safe sequence)라고 함

반면 불안정 상태는 안정 상태가 아닌 상황

즉, 데드락 발생 가능성이 있는 상황이며 교착 상태(데드락)는 불안정 상태일 때 발생할 수 있음

데드락 ⊂ 불안정 상태

> 회피 알고리즘은 자원을 할당한 후에도 시스템이 항상 Safe state에 있을 수 있도록 할당을 허용하자는 것이 기본 특징
>
> 이러한 특징을 살린 알고리즘으로 유명한 것이 은행원 알고리즘

<br>

`은행원 알고리즘(Banker's Algorithm)`

은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는데서 유래함

프로세스가 자원을 요구할 때, 시스템은 자원을 할당한 후에도 안정 상태로 남아있게 되는지 사전에 검사하여 교착 상태 회피

안정 상태면 자원 할당, 아니면 다른 프로세스들이 자원 해지까지 대기

미리 최대 자원 요구량을 알아야 하고, 할당할 수 있는 자원 수가 일정해야 하는 등 사용에 있어 제약조건이 많고, 그에 따른 자원 이용도 하락 등 단점도 존재

<br>

### 데드락 탐지(Detection) 및 회복(Recovery)

교착 상태가 되도록 허용한 다음 탐지, 회복시키는 방법

1. 탐지 기법

Allocation, Request, Available 등으로 시스템에 데드락이 발생했는지 여부를 탐색

즉, 은행원 알고리즘에서 했던 방식과 유사하게 현재 시스템의 자원 할당 상태를 가지고 파악

이 외에도 자원 할당 그래프를 통해 탐지하는 방법 존재

자원 요청 시, 탐지 알고리즘을 실행시키기 때문에 그에 대한 오버헤드가 발생

2. 회복 기법

순환 대기에서 벗어나 데드락으로부터 회복하기 위한 방법

`프로세스 중단`

- 교착 상태에 빠진 모든 프로세스 중단

  계속 연산중이던 프로세스들도 모두 일시에 중단되어 부분결과가 폐기될 수 있음

- 프로세스를 하나씩 중단시킬 때마다 탐지 알고리즘으로 데드락을 탐지하며 회복시킴

  매번 탐지 알고리즘을 수행해야 하므로 부담이 되는 작업일 수 있음

`자원 선점`

프로세스에 할당된 자원을 선점해서, 교착 상태를 해결할 때까지 그 자원을 다른 프로세스에 할당 (해당 프로세스 일시정지 시킴)

우선 순위가 낮은 프로세스나 수행 횟수 적은 프로세스 위주로 프로세스 자원 선점

<br>

## 4. 식사하는 철학자 (Dining Philosophers)

교착상태를 설명

> 5명의 철학자가 원탁에 앉아서 식사를 한다.
>
> 철학자들 사이에는 포크가 하나씩 놓여 있고, 철학자들은 다음의 과정을 통해 식사를 한다.
>
> 1. 일정 시간 생각을 한다.
> 2. 왼쪽 포크가 사용 가능해질 때까지 대기한다. 만약 사용 가능하다면 집어든다.
> 3. 오른쪽 포크가 사용 가능해질 때까지 대기한다. 만약 사용 가능하다면 집어든다.
> 4. 양쪽의 포크를 잡으면 일정 시간만큼 식사를 한다.
> 5. 오른쪽 포크를 내려놓는다.
> 6. 왼쪽 포크를 내려놓는다.
> 7. 다시 1번으로 돌아간다.
>
> 만약 모든 철학자들이 자신의 왼쪽포크를 잡는다면, 모든 철학자들이 오른쪽 포크가 사용 가능해질 때까지 기다려야한다.

<br>

#### 해결 방법

1. 타임아웃 설정

   철학자가 포크를 집고 일정 시간 내에 다른 쪽 포크를 획득하는데 실패한다면, 포크를 반납하게 함

   가장 간단하지만 타임아웃에 따른 딜레이 존재

2. 철학자들 중 하나는 포크를 오른쪽부터 잡게함

   예를 들어 1번 철학자는 왼쪽부터, 2번 철학자는 오른쪽부터 잡음

   1번 철학자가 왼쪽 포크만 잡은 상태에서 행동권이 2번 철학자에게 넘어간다고 하더라도, 2번 철학자는 자신의 오른쪽 포크가 현재 사용 불가능하기 때문에, 첫번째 포크를 잡으려는 상황에서 멈춰 있게 됨

   이 상황에서 1번 철학자로 다시 행동권이 넘어오게 되면 1번 철학자는 자신의 오른쪽 포크를 잡고 다시 식사를 할 수 있게 됨

3. n명이 앉을 수 있는 테이블에서 철학자를 n-1명만 앉힘

4. 한 철학자가 젓가락 두개를 모두 집을 수 있는 상황에서만 젓가락 집도록 허용

<br>

## 5. 기아 상태 (Starvation)

> 특정 프로세스의 우선순위가 낮아 원하는 자원을 계속 할당받지 못하는 상태

<br>

#### 교착 상태와의 차이

교착상태는 프로세스가 자원을 얻지 못해 다음 처리를 하지 못하는 상태를 말하고 기아 상태는 프로세스가 원하는 자원을 계속 할당 받지 못하는 상태

즉 교착 상태는 여러 프로세스가 동일한 자원 점유를 원할 때 발생하고 기아 상태는 여러 프로세스가 자원을 점유하기 위해 경쟁 할 때 특정 프로세스는 영원히 자원 할당을 받지 못하는 것

<br>

## 6. 주요 질문

1. 데드락(교착 상태)이 뭔가요? 발생 조건에 대해 말해보세요.

2. 회피 기법인 은행원 알고리즘이 뭔지 설명해보세요.

3. 교착 상태를 설명하는 식사하는 철학자 문제에 대해 설명해보세요.

   > 교착 상태 해결책
   >
   > 1. n명이 앉을 수 있는 테이블에서 철학자를 n-1명만 앉힘
   > 2. 한 철학자가 젓가락 두개를 모두 집을 수 있는 상황에서만 젓가락 집도록 허용
   > 3. 누군가는 왼쪽 젓가락을 먼저 집지 않고 오른쪽 젓가락을 먼저 집도록 허용

<br>
